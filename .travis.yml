os: linux
dist: xenial
language: java
jdk: openjdk11

addons:
  firefox: "76.0.1"

git:
  depth: false
  quiet: true

services:
  - xvfb
  - docker

cache:
  directories:
    - ${HOME}/.m2/repository
    
# the cache can grow constantly
before_cache:
  - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-share*

branches:
  only:
    - master
    - /^SP\/.+$/
    - fix/APPS-228

stages:
  - build
  - tests
  - release
  
before_install:
  - "cp _ci/.travis.settings.xml $HOME/.m2/settings.xml"

jobs:
  include:
    - name: "Build"
      stage: build
      script: mvn clean install

    - name: "WhiteSource"
      stage: build
      # only on SP branches or master and if it is not a PR
      if: fork = false AND (branch = develop OR branch =~ /support\/SP\/.*/) AND type != pull_request
      script:
        # Download the latest version of WhiteSource Unified Agent
        - curl -LJO https://github.com/whitesource/unified-agent-distribution/releases/latest/download/wss-unified-agent.jar
        # Run WhiteSource Unified Agent
        - java -jar wss-unified-agent.jar -apiKey ${WHITESOURCE_API_KEY} -c _ci/.wss-unified-agent.config 

    - name: "Source Clear Scan (SCA)"
      stage: build
      # only on SP branches or master and if it is not a PR
      if: fork = false AND (branch = develop OR branch =~ /support\/SP\/.*/) AND type != pull_request
      # Run Veracode
      install: skip
      script: travis_wait 30 bash _ci/source_clear.sh


   