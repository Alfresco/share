dist: xenial
language: java
jdk: openjdk8

services:
  - docker

addons:
  firefox: "43.0.1"

git:
  quiet: true

cache:
  directories:
    - $HOME/.m2/repository
# the cache can grow constantly
# before_cache:
#   - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-share*
#   - rm -rf $HOME/.m2/repository/org/alfresco/share*
#   - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-content-services-share-*
#   - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-wcmqs*

branches:
  only:
    - /^SP\/.+$/
    - /feature\/.*/

env:
  global:
    - DISPLAY=:99.0

stages:
  - tests

before_install: travis_retry bash scripts/travis/init.sh

jobs:
  include:   
    - name: "Testing"
      install: mvn clean install -DskipTests -PenterpriseDocker
      before_script:
        - bash scripts/travis/start-compose.sh share-po/docker-compose.yml
        - bash scripts/travis/wait-for-alfresco-start.sh "http://localhost:8080/alfresco"
        - cd share-po
      script:
        # - mvn clean install -B -U -Pdefault,alfresco-content-services-tests -DskipTests=false -Dwebdriver.grid.url=http://127.0.0.1:4444/wd/hub -Dwebdriver.local.grid=true -Dwebdriver.browser=RemoteFireFox -Dwebdriver.localGrid=false -Dwebdriver.element.wait.time=20000 -Dwebdriver.page.render.wait.time=60000 -Dshare.target=http://127.0.0.1:8080/share -Dshare.url=http://127.0.0.1:8080/share -Dtest.exclude=.*Bug42,.*Bug,chromeOnly,Hybrid,download,NonGrid -Dtest.include=unit,alfresco-one,Enterprise4.2,Enterprise-only -Dtestng.suite.filename=src/test/resources/testng_share_po.xml
        - xvfb-run --server-args="-screen 0 1920x1080x24" mvn clean install -B -U -Pdefault,alfresco-content-services-tests -DskipTests=false -Dwebdriver.local.grid=true -Dwebdriver.browser=RemoteFireFox -Dwebdriver.localGrid=false -Dwebdriver.element.wait.time=20000 -Dwebdriver.page.render.wait.time=60000 -Dshare.target=http://127.0.0.1:8080/share -Dshare.url=http://127.0.0.1:8080/share -Dtest.exclude=.*Bug42,.*Bug,chromeOnly,Hybrid,download,NonGrid -Dtestng.suite.filename=src/test/resources/AdminConsoleSuite.xml

#    - name: "Building Docker Image"
#      install: skip
#      script: mvn clean install -DskipTests -PenterpriseDocker